import streamlit as st
import pandas as pd
from datetime import datetime

# --- 1. CONFIGURACI칍N DE LA P츼GINA ---
st.set_page_config(page_title="Calendario Tributario 2026", layout="centered")

st.title("游늰 Buscador de Vencimientos DIAN 2026")
st.markdown("Ingresa el NIT de tu empresa para ver tus obligaciones tributarias.")

# --- 2. BASE DE DATOS (SIMULADA BASADA EN EL PDF) ---
# En una app real, esto ser칤a un archivo JSON o una base de datos SQL completa.
# Aqu칤 he transcrito algunos ejemplos basados en el documento adjunto.

data_impuestos = [
    # Ejemplo Renta Personas Jur칤dicas (Basado en source: 17, 19)
    {"impuesto": "Renta Personas Jur칤dicas - 1ra Cuota", "digito": 1, "fecha": "2026-05-11"},
    {"impuesto": "Renta Personas Jur칤dicas - 1ra Cuota", "digito": 2, "fecha": "2026-05-12"},
    {"impuesto": "Renta Personas Jur칤dicas - 1ra Cuota", "digito": 3, "fecha": "2026-05-13"},
    
    # Ejemplo IVA Bimestral (Basado en source: 45, 52)
    {"impuesto": "IVA Bimestral - Ene/Feb", "digito": 1, "fecha": "2026-03-10"},
    {"impuesto": "IVA Bimestral - Ene/Feb", "digito": 2, "fecha": "2026-03-11"},
    
    # Ejemplo Retefuente (Basado en source: 73, 74)
    {"impuesto": "Retenci칩n en la Fuente - Enero", "digito": 1, "fecha": "2026-02-10"},
    {"impuesto": "Retenci칩n en la Fuente - Enero", "digito": 2, "fecha": "2026-02-11"},
    
    # ... Se deben llenar el resto de fechas del PDF ...
]

df = pd.DataFrame(data_impuestos)

# --- 3. INTERFAZ DE USUARIO ---

col1, col2 = st.columns([3, 1])
with col1:
    nit_input = st.text_input("N칰mero de NIT (Sin d칤gito de verificaci칩n)", max_chars=15)
with col2:
    tipo_persona = st.selectbox("Tipo", ["Jur칤dica", "Natural", "Gran Contribuyente"])

if st.button("Buscar Vencimientos"):
    if nit_input and nit_input.isdigit():
        
        # L칩gica para extraer d칤gito
        ultimo_digito = int(nit_input[-1])
        
        # Filtrar el DataFrame
        resultados = df[df['digito'] == ultimo_digito].copy()
        
        # Ordenar por fecha
        resultados['fecha_dt'] = pd.to_datetime(resultados['fecha'])
        resultados = resultados.sort_values(by='fecha_dt')
        
        # --- 4. VISUALIZACI칍N ---
        st.divider()
        st.subheader(f"Vencimientos para NIT terminado en {ultimo_digito}")
        
        if not resultados.empty:
            # Opci칩n A: Tabla simple
            st.dataframe(resultados[['fecha', 'impuesto']].style.highlight_max(axis=0), use_container_width=True)
            
            # Opci칩n B: Formato Tarjeta (M치s amigable)
            for index, row in resultados.iterrows():
                with st.expander(f"{row['fecha']} - {row['impuesto']}"):
                    st.write(f"**Obligaci칩n:** {row['impuesto']}")
                    st.write(f"**Fecha L칤mite:** {row['fecha']}")
                    # Aqu칤 podr칤as agregar l칩gica de sem치foro (Verde: falta mucho, Rojo: urgente)
                    dias_restantes = (row['fecha_dt'] - datetime.now()).days
                    if dias_restantes < 0:
                        st.error(f"Vencido hace {abs(dias_restantes)} d칤as")
                    elif dias_restantes < 5:
                        st.warning(f"춰Vence en {dias_restantes} d칤as!")
                    else:
                        st.success(f"Faltan {dias_restantes} d칤as")
        else:
            st.info("No hay datos cargados en el demo para este d칤gito a칰n.")
            
    else:
        st.error("Por favor ingresa un NIT v치lido (solo n칰meros).")

# --- Footer ---
st.caption("Fuente: Calendario Tributario DIAN 2026 [cite: 2]")
